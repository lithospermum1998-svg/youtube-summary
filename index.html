<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>YouTube要約（Gemini）</title>

<style>
body {
  font-family: -apple-system, BlinkMacSystemFont, sans-serif;
  background: #f2f2f7;
  padding: 16px;
}
h1 {
  font-size: 20px;
}
input, textarea, button {
  width: 100%;
  margin-top: 12px;
  padding: 12px;
  font-size: 16px;
  border-radius: 10px;
}
input, textarea {
  border: 1px solid #ccc;
}
button {
  background: #007aff;
  color: white;
  border: none;
}
textarea {
  height: 260px;
}
.note {
  font-size: 13px;
  color: #666;
  margin-top: 8px;
}
</style>
</head>

<body>

<h1>YouTube要約（Gemini）</h1>

<input id="url" placeholder="YouTubeのURLを貼る">
<input id="apikey" placeholder="Gemini APIキー">

<button onclick="summarize()">要約する</button>

<div class="note">
・字幕あり：高精度<br>
・字幕なし：タイトル等を元にした推測要約
</div>

<textarea id="result" placeholder="ここに要約が表示されます"></textarea>

<script>
async function summarize() {
  const url = document.getElementById("url").value.trim();
  const apiKey = document.getElementById("apikey").value.trim();
  const result = document.getElementById("result");

  result.value = "処理中…";

  const videoId =
    url.match(/v=([^&]+)/)?.[1] ||
    url.match(/youtu\.be\/([^?]+)/)?.[1];

  if (!videoId || !apiKey) {
    alert("URLまたはAPIキーが不正です");
    result.value = "";
    return;
  }

  localStorage.setItem("geminiKey", apiKey);

  let prompt = "";
  let fallback = false;

  // --- 字幕取得 ---
  try {
    const captionUrl =
      `https://video.google.com/timedtext?lang=ja&v=${videoId}&fmt=srv3`;
    const res = await fetch(captionUrl);
    const xmlText = await res.text();

    if (xmlText.includes("<text")) {
      const parser = new DOMParser();
      const xml = parser.parseFromString(xmlText, "text/xml");
      const captions = [...xml.getElementsByTagName("text")]
        .map(t => t.textContent.replace(/\n/g, " "))
        .join(" ");

      prompt = `
以下はYouTube動画の字幕です。
日本語で要点を整理して要約してください。

【要約条件】
・何についての動画か
・重要ポイント
・結論

字幕:
${captions}
`;
    }
  } catch {}

  // --- 字幕なしフォールバック（重要） ---
  if (!prompt) {
    fallback = true;
    prompt = `
あなたはYouTube動画の内容を整理するアシスタントです。

以下の動画について、
「一般的なYouTube動画の構成」を前提に、
想定される内容を日本語で要約してください。

【前提情報】
・動画は10〜15分程度
・解説またはトーク形式
・視聴者向けに要点を伝える内容

【出力形式】
・動画の概要
・話していそうなポイント
・まとめ（想定）

YouTube URL:
https://www.youtube.com/watch?v=${videoId}
`;
  }

  try {
    const res = await fetch(
      `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${apiKey}`,
      {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          contents: [{
            role: "user",
            parts: [{ text: prompt }]
          }],
          generationConfig: {
            temperature: 0.6,
            maxOutputTokens: 600
          }
        })
      }
    );

    const data = await res.json();
    const text = data.candidates?.[0]?.content?.parts?.[0]?.text;

    result.value =
      (fallback ? "※字幕なし動画のため推測を含む要約です\n\n" : "")
      + (text || "Geminiが内容を生成できませんでした");

  } catch (e) {
    result.value = "通信エラーが発生しました";
  }
}

// APIキー復元
document.getElementById("apikey").value =
  localStorage.getItem("geminiKey") || "";
</script>

</body>
</html>
